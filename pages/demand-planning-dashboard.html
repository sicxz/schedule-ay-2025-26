<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demand Planning - Design Scheduler</title>
    <link rel="stylesheet" href="../css/shared.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            margin: 0 0 8px 0;
            font-size: 1.75rem;
        }

        .header-title p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .back-link {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .back-link:hover {
            opacity: 1;
        }

        .controls {
            padding: 20px 32px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group select {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            min-width: 150px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 24px 32px;
            background: #f8f9fa;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }

        .summary-card.increase {
            border-left: 4px solid var(--danger);
        }

        .summary-card.reduce {
            border-left: 4px solid var(--warning);
        }

        .summary-card.optimal {
            border-left: 4px solid var(--success);
        }

        .summary-card.info {
            border-left: 4px solid var(--info);
        }

        .summary-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .summary-card.increase .summary-number { color: var(--danger); }
        .summary-card.reduce .summary-number { color: var(--warning); }
        .summary-card.optimal .summary-number { color: var(--success); }
        .summary-card.info .summary-number { color: var(--info); }

        .summary-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .content {
            padding: 32px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prediction-grid {
            display: grid;
            gap: 16px;
        }

        .prediction-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr;
            gap: 20px;
            align-items: center;
            transition: all 0.2s;
        }

        .prediction-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .prediction-card.increase {
            border-left: 4px solid var(--danger);
            background: #fef2f2;
        }

        .prediction-card.reduce {
            border-left: 4px solid var(--warning);
            background: #fffbeb;
        }

        .prediction-card.optimal {
            border-left: 4px solid var(--success);
        }

        .course-info h3 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            color: #1f2937;
        }

        .course-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .utilization-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .utilization-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .utilization-fill.low { background: var(--success); }
        .utilization-fill.medium { background: var(--warning); }
        .utilization-fill.high { background: var(--danger); }

        .recommendation-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .recommendation-badge.increase {
            background: #fecaca;
            color: #991b1b;
        }

        .recommendation-badge.reduce {
            background: #fef3c7;
            color: #92400e;
        }

        .recommendation-badge.optimal {
            background: #d1fae5;
            color: #065f46;
        }

        .recommendation-badge.adequate {
            background: #e5e7eb;
            color: #4b5563;
        }

        .confidence-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .confidence-dots {
            display: flex;
            gap: 4px;
        }

        .confidence-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e5e7eb;
        }

        .confidence-dot.filled { background: var(--primary); }

        .analysis-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
            display: none;
        }

        .prediction-card.expanded .analysis-section {
            display: block;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .analysis-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
        }

        .analysis-item h4 {
            margin: 0 0 8px 0;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .analysis-item p {
            margin: 0;
            font-size: 0.9rem;
            color: #1f2937;
        }

        .prerequisite-flow {
            background: #f0f9ff;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .prerequisite-flow h4 {
            margin: 0 0 12px 0;
            color: #0369a1;
            font-size: 0.9rem;
        }

        .flow-source {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .flow-arrow {
            color: #0369a1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .expand-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 4px 8px;
        }

        .expand-btn:hover {
            text-decoration: underline;
        }

        .track-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .track-chip {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            background: #f3f4f6;
            color: #4b5563;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .track-chip.active {
            background: var(--primary);
            color: white;
        }

        .track-chip:hover:not(.active) {
            background: #e5e7eb;
        }

        @media (max-width: 1024px) {
            .prediction-card {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .metric {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <a href="../index.html" class="back-link">← Back to Schedule</a>
                    <h1>Demand Planning Dashboard</h1>
                    <p>Predictive analytics for course scheduling and section planning</p>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>Target Quarter</label>
                <select id="quarterSelect">
                    <option value="fall">Fall 2026</option>
                    <option value="winter">Winter 2027</option>
                    <option value="spring">Spring 2027</option>
                </select>
            </div>

            <div class="control-group">
                <label>View</label>
                <select id="viewSelect">
                    <option value="all">All Courses</option>
                    <option value="attention">Needs Attention</option>
                    <option value="optimal">Optimal Capacity</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="runPredictions()">
                Run Predictions
            </button>

            <button class="btn" style="margin-left: auto;" onclick="exportPredictions()">
                Export Report
            </button>
        </div>

        <div class="summary-cards" id="summaryCards">
            <div class="summary-card info">
                <div class="summary-number" id="totalCourses">--</div>
                <div class="summary-label">Total Courses Analyzed</div>
            </div>
            <div class="summary-card increase">
                <div class="summary-number" id="needIncrease">--</div>
                <div class="summary-label">Need More Sections</div>
            </div>
            <div class="summary-card reduce">
                <div class="summary-number" id="canReduce">--</div>
                <div class="summary-label">Can Reduce Sections</div>
            </div>
            <div class="summary-card optimal">
                <div class="summary-number" id="atOptimal">--</div>
                <div class="summary-label">At Optimal Capacity</div>
            </div>
        </div>

        <div class="content">
            <!-- Track Filter -->
            <div class="track-filter" id="trackFilter">
                <button class="track-chip active" data-track="all">All Tracks</button>
            </div>

            <!-- Courses Needing Attention -->
            <div class="section" id="attentionSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>Courses Needing Attention</span>
                    </h2>
                </div>
                <div class="prediction-grid" id="attentionGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- All Predictions -->
            <div class="section" id="allPredictionsSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>All Course Predictions</span>
                    </h2>
                </div>
                <div class="prediction-grid" id="predictionsGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/prerequisite-graph.js"></script>
    <script src="../js/demand-predictor.js"></script>
    <script>
        // State
        let predictions = [];
        let currentQuarter = 'fall';
        let currentView = 'all';
        let currentTrack = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing Demand Planning Dashboard...');

            // Initialize predictor
            const result = await DemandPredictor.init({
                graphPath: '../data/prerequisite-graph.json',
                enrollmentPath: '../enrollment-dashboard-data.json',
                catalogPath: '../data/course-catalog.json'
            });

            if (!result.success) {
                showError('Failed to initialize predictor: ' + result.error);
                return;
            }

            // Setup event listeners
            document.getElementById('quarterSelect').addEventListener('change', (e) => {
                currentQuarter = e.target.value;
                runPredictions();
            });

            document.getElementById('viewSelect').addEventListener('change', (e) => {
                currentView = e.target.value;
                renderPredictions();
            });

            // Initialize track filter
            initTrackFilter();

            // Run initial predictions
            runPredictions();
        });

        async function initTrackFilter() {
            const tracks = PrerequisiteGraph.getAllTracks();
            const filterContainer = document.getElementById('trackFilter');

            Object.entries(tracks).forEach(([key, track]) => {
                const chip = document.createElement('button');
                chip.className = 'track-chip';
                chip.dataset.track = key;
                chip.textContent = track.name;
                chip.onclick = () => selectTrack(key);
                filterContainer.appendChild(chip);
            });
        }

        function selectTrack(trackKey) {
            currentTrack = trackKey;

            // Update chip styles
            document.querySelectorAll('.track-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.track === trackKey);
            });

            renderPredictions();
        }

        function runPredictions() {
            console.log('Running predictions for', currentQuarter);

            // Show loading
            document.getElementById('attentionGrid').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            document.getElementById('predictionsGrid').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            // Get predictions
            predictions = DemandPredictor.predictQuarterDemand(currentQuarter);

            // Update summary
            updateSummary();

            // Render predictions
            renderPredictions();
        }

        function updateSummary() {
            const attention = DemandPredictor.getCoursesNeedingAttention(currentQuarter);

            document.getElementById('totalCourses').textContent = predictions.length;
            document.getElementById('needIncrease').textContent = attention.needMoreSections.length;
            document.getElementById('canReduce').textContent = attention.canReduceSections.length;
            document.getElementById('atOptimal').textContent = attention.atOptimal.length;
        }

        function renderPredictions() {
            // Filter by track
            let filtered = predictions;
            if (currentTrack !== 'all') {
                filtered = predictions.filter(p => {
                    const tracks = PrerequisiteGraph.getTracksForCourse(p.courseCode);
                    return tracks.includes(currentTrack);
                });
            }

            // Filter by view
            if (currentView === 'attention') {
                filtered = filtered.filter(p =>
                    p.recommendation === 'increase' || p.recommendation === 'reduce'
                );
            } else if (currentView === 'optimal') {
                filtered = filtered.filter(p =>
                    p.recommendation === 'optimal' || p.recommendation === 'adequate'
                );
            }

            // Render attention section
            const attentionCourses = filtered.filter(p =>
                p.recommendation === 'increase' || p.recommendation === 'reduce'
            );

            const attentionGrid = document.getElementById('attentionGrid');
            if (attentionCourses.length === 0) {
                attentionGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">All courses have adequate capacity for ${currentQuarter} quarter</div>
                    </div>
                `;
            } else {
                attentionGrid.innerHTML = attentionCourses.map(renderPredictionCard).join('');
            }

            // Render all predictions
            const predictionsGrid = document.getElementById('predictionsGrid');
            if (filtered.length === 0) {
                predictionsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">No courses match the current filters</div>
                    </div>
                `;
            } else {
                predictionsGrid.innerHTML = filtered.map(renderPredictionCard).join('');
            }
        }

        function renderPredictionCard(prediction) {
            const utilizationClass = prediction.utilizationRate > 100 ? 'high' :
                                    prediction.utilizationRate > 80 ? 'medium' : 'low';

            const confidenceDots = [1, 2, 3].map(i =>
                `<div class="confidence-dot ${prediction.confidence >= i * 0.33 ? 'filled' : ''}"></div>`
            ).join('');

            const trendIcon = prediction.trend === 'growing' ? '' :
                             prediction.trend === 'declining' ? '' : '';

            return `
                <div class="prediction-card ${prediction.recommendation}" id="card-${prediction.courseCode.replace(/\s+/g, '-')}">
                    <div class="course-info">
                        <h3>${prediction.courseCode}</h3>
                        <p>${prediction.courseName || ''} ${trendIcon}</p>
                    </div>

                    <div class="metric">
                        <div class="metric-value">${prediction.predictedDemand}</div>
                        <div class="metric-label">Predicted Demand</div>
                    </div>

                    <div class="metric">
                        <div class="metric-value">${prediction.currentCapacity}</div>
                        <div class="metric-label">Current Capacity</div>
                        <div class="utilization-bar">
                            <div class="utilization-fill ${utilizationClass}"
                                 style="width: ${Math.min(100, prediction.utilizationRate)}%"></div>
                        </div>
                    </div>

                    <div class="metric">
                        <div class="confidence-indicator">
                            <div class="confidence-dots">${confidenceDots}</div>
                            <span style="font-size: 0.8rem; color: #6b7280">${prediction.confidenceLevel}</span>
                        </div>
                        <div class="metric-label">Confidence</div>
                    </div>

                    <div>
                        <span class="recommendation-badge ${prediction.recommendation}">
                            ${getRecommendationIcon(prediction.recommendation)}
                            ${getRecommendationText(prediction)}
                        </span>
                        <button class="expand-btn" onclick="toggleAnalysis('${prediction.courseCode.replace(/\s+/g, '-')}')">
                            View Details
                        </button>
                    </div>

                    <div class="analysis-section">
                        <div class="analysis-grid">
                            <div class="analysis-item">
                                <h4>Historical Trend</h4>
                                <p>${prediction.analysis?.historical?.method || 'N/A'} -
                                   ${prediction.analysis?.historical?.trend || 'stable'}</p>
                            </div>
                            <div class="analysis-item">
                                <h4>Current Sections</h4>
                                <p>${prediction.currentSections} sections @ ${prediction.sectionCapacity} cap</p>
                            </div>
                            <div class="analysis-item">
                                <h4>Utilization Rate</h4>
                                <p>${prediction.utilizationRate}%</p>
                            </div>
                            <div class="analysis-item">
                                <h4>Suggested Sections</h4>
                                <p>${prediction.suggestedSections}</p>
                            </div>
                        </div>

                        ${renderPrerequisiteFlow(prediction)}
                    </div>
                </div>
            `;
        }

        function renderPrerequisiteFlow(prediction) {
            const sources = prediction.analysis?.prerequisite?.sources;
            if (!sources || sources.length === 0) return '';

            return `
                <div class="prerequisite-flow">
                    <h4>Prerequisite Pipeline</h4>
                    ${sources.map(s => `
                        <div class="flow-source">
                            <strong>${s.course}</strong>
                            <span class="flow-arrow">→</span>
                            <span>${s.enrollment} students × ${Math.round(s.flowRate * 100)}% flow rate = ${s.expected} expected</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getRecommendationIcon(rec) {
            switch(rec) {
                case 'increase': return '+';
                case 'reduce': return '-';
                case 'optimal': return '✓';
                default: return '';
            }
        }

        function getRecommendationText(prediction) {
            switch(prediction.recommendation) {
                case 'increase':
                    return `Add ${prediction.suggestedSections - prediction.currentSections} section(s)`;
                case 'reduce':
                    return `Remove ${prediction.currentSections - prediction.suggestedSections} section(s)`;
                case 'optimal':
                    return 'Optimal capacity';
                default:
                    return 'Adequate';
            }
        }

        function toggleAnalysis(cardId) {
            const card = document.getElementById('card-' + cardId);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        function exportPredictions() {
            const summary = DemandPredictor.generateQuarterSummary(currentQuarter);

            const report = {
                generatedAt: new Date().toISOString(),
                quarter: currentQuarter,
                summary: summary,
                predictions: predictions
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `demand-predictions-${currentQuarter}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showError(message) {
            document.getElementById('attentionGrid').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">Error: ${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
