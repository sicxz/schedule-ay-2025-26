<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment Trends - Design Scheduler</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .back-link {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) translateX(-5px);
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, select:focus {
            border-color: #667eea;
            outline: none;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-bar {
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            background: #fff;
            border-bottom: 2px solid #dee2e6;
        }

        .stat-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.declining {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .stat-card.growing {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
        }

        .stat-card.stable {
            background: linear-gradient(135deg, #74c0fc 0%, #4dabf7 100%);
            color: white;
        }

        .stat-card.total {
            background: linear-gradient(135deg, #ffd93d 0%, #ff9f1c 100%);
            color: #333;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1000px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
        }

        .chart-container h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
        }

        .chart-wrapper.tall {
            height: 350px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #495057;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .trend-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .trend-badge.declining {
            background: #ff6b6b;
            color: white;
        }

        .trend-badge.growing {
            background: #51cf66;
            color: white;
        }

        .trend-badge.stable {
            background: #74c0fc;
            color: white;
        }

        .trend-badge.new {
            background: #9b59b6;
            color: white;
        }

        .insights-panel {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }

        .insights-panel h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .insight-item {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        .insight-item h3 {
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .capacity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .capacity-card {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
            background: white;
        }

        .capacity-card.over {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .capacity-card.near {
            border-left-color: #ffd93d;
            background: #fffdf0;
        }

        .capacity-card.under {
            border-left-color: #51cf66;
            background: #f0fdf4;
        }

        .capacity-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .capacity-details {
            font-size: 0.85em;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Schedule</a>
            <h1>üìä Enrollment Trends Dashboard</h1>
            <p class="subtitle">EWU Design Program Analytics 2022-2025</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="courseFilter">Filter by Course:</label>
                <select id="courseFilter">
                    <option value="all">All Courses</option>
                    <option value="foundation">Foundation (100-200)</option>
                    <option value="intermediate">Intermediate (300-level)</option>
                    <option value="advanced">Advanced (400-level)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="trendFilter">Filter by Trend:</label>
                <select id="trendFilter">
                    <option value="all">All Trends</option>
                    <option value="declining">Declining Only</option>
                    <option value="growing">Growing Only</option>
                    <option value="stable">Stable Only</option>
                </select>
            </div>

            <div class="control-group">
                <label for="academicYearFilter">Academic Year:</label>
                <select id="academicYearFilter">
                    <option value="all">All Years (2022-2026)</option>
                    <option value="2022-23">2022-23</option>
                    <option value="2023-24">2023-24</option>
                    <option value="2024-25" selected>2024-25 (Most Recent Complete)</option>
                    <option value="2025-26">2025-26 (Current)</option>
                </select>
            </div>

            <button onclick="window.location.href='pages/workload-dashboard.html'" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üë• Workload</button>
            <button onclick="window.location.href='pages/applied-learning-dashboard.html'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üìö Applied Learning</button>
            <button onclick="window.location.href='pages/recommendations-dashboard.html'" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">üí° Recommendations</button>
            <button onclick="window.location.href='pages/capacity-planning-dashboard.html'" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">üìä Capacity</button>
            <button onclick="window.location.href='pages/course-optimizer-dashboard.html'" style="background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);">üéì Optimizer</button>
        </div>

        <div class="stats-bar">
            <div class="stat-card total">
                <div class="stat-number" id="totalCourses">28</div>
                <div class="stat-label">Total Courses Tracked</div>
            </div>
            <div class="stat-card declining">
                <div class="stat-number" id="decliningCount">3</div>
                <div class="stat-label">Declining Courses</div>
            </div>
            <div class="stat-card growing">
                <div class="stat-number" id="growingCount">5</div>
                <div class="stat-label">Growing Courses</div>
            </div>
            <div class="stat-card stable">
                <div class="stat-number" id="stableCount">20</div>
                <div class="stat-label">Stable Courses</div>
            </div>
        </div>

        <div class="content">
            <!-- Forecast Panel -->
            <div id="forecastPanel" class="insights-panel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-top: 0; margin-bottom: 30px;">
                <h2>üîÆ Enrollment Forecast</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="insight-item" style="background: rgba(255,255,255,0.25);">
                        <h3 style="font-size: 2em; margin-bottom: 10px;" id="forecastPredicted">--</h3>
                        <p style="font-size: 0.9em; opacity: 0.9;">Predicted Enrollment</p>
                    </div>
                    <div class="insight-item" style="background: rgba(255,255,255,0.25);">
                        <h3 style="font-size: 1.5em; margin-bottom: 10px;"><span id="forecastLower">--</span> - <span id="forecastUpper">--</span></h3>
                        <p style="font-size: 0.9em; opacity: 0.9;">95% Confidence Interval</p>
                    </div>
                    <div class="insight-item" style="background: rgba(255,255,255,0.25);">
                        <h3 style="font-size: 1.5em; margin-bottom: 10px;" id="forecastTrend">--</h3>
                        <p style="font-size: 0.9em; opacity: 0.9;">Enrollment Trend</p>
                    </div>
                    <div class="insight-item" style="background: rgba(255,255,255,0.25);">
                        <h3 style="font-size: 1.5em; margin-bottom: 10px;" id="forecastGrowth">--</h3>
                        <p style="font-size: 0.9em; opacity: 0.9;">Growth Rate (QoQ)</p>
                    </div>
                </div>
                <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.9;">
                    üìä Based on linear regression analysis of 10 quarters of enrollment data (Fall 2022 - Fall 2025)
                </p>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container full-width">
                    <h2>Overall Enrollment Trends (Fall 2022 - Fall 2025)</h2>
                    <div class="chart-wrapper">
                        <canvas id="overallTrendChart"></canvas>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin-top: 15px;">
                        <strong>Note:</strong> This shows unique students enrolled in <em>at least one Design course</em> per quarter,
                        not total declared Design majors. Students may skip quarters for gen-eds, internships, or personal reasons.
                        <br><strong>Current declared Design majors:</strong> 124 students (Fall 2025)
                    </p>
                </div>

                <div class="chart-container">
                    <h2>Total Enrollment by Course Level (Annual Average)</h2>
                    <div class="chart-wrapper">
                        <canvas id="courseLevelChart"></canvas>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin-top: 15px;">
                        <strong>Note:</strong> Sum of average enrollments across all courses in each level.
                    </p>
                </div>

                <div class="chart-container">
                    <h2>Course Trend Distribution (by count)</h2>
                    <div class="chart-wrapper">
                        <canvas id="trendPieChart"></canvas>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin-top: 15px;">
                        <strong>Note:</strong> Number of courses in each trend category based on multi-year enrollment patterns.
                    </p>
                </div>

                <div class="chart-container">
                    <h2>Top 10 Courses by Avg Enrollment</h2>
                    <div class="chart-wrapper">
                        <canvas id="topCoursesChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>Winter Quarter Deep Dive</h2>
                    <div class="chart-wrapper">
                        <canvas id="winterTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>Quarterly Participation</h2>
                    <div class="chart-wrapper">
                        <canvas id="programHeadcountChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>Cumulative Enrollments by AY</h2>
                    <div class="chart-wrapper">
                        <canvas id="cumulativeCreditsChart"></canvas>
                    </div>
                </div>

                <div class="chart-container full-width">
                    <h2>Faculty Capacity Planning</h2>
                    <div class="chart-wrapper tall">
                        <canvas id="facultyWorkloadChart"></canvas>
                    </div>
                    <div id="capacityPlanningInfo" style="background: #e7f5ff; border-left: 4px solid #339af0; padding: 12px 16px; margin-top: 16px; border-radius: 8px; font-size: 0.85em;">
                        <strong>üìä Capacity:</strong> Full-time faculty baseline. Adjunct capacity = 0 for planning.
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <h2>üìä Capacity Utilization</h2>
                    <p style="color: #666; font-size: 0.85em; margin-bottom: 10px;">
                        üî¥ Over | üü° Near (90%+) | üü¢ Under
                    </p>
                    <div class="capacity-grid" id="capacityGrid"></div>
                </div>

                <div class="chart-container">
                    <h2>Course Data</h2>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table" id="courseDataTable">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Avg</th>
                                    <th>Peak</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="courseTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="insights-panel" style="margin-top: 20px;">
                <h2>üí° Key Insights</h2>
                <div id="insightsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Enrollment data from the main analyzer
        const enrollmentData = {
            "DESN 100": { average: 35, peak: 48, trend: "declining", peakQuarter: "fall-2022", quarterly: { "winter-2023": 38, "winter-2024": 24, "winter-2025": 22 } },
            "DESN 200": { average: 26, peak: 44, trend: "growing", peakQuarter: "fall-2024" },
            "DESN 216": { average: 52, peak: 73, trend: "declining", peakQuarter: "fall-2022", quarterly: { "winter-2023": { total: 38 }, "winter-2024": { total: 25 }, "winter-2025": { total: 22 } } },
            "DESN 243": { average: 17, peak: 25, trend: "stable", peakQuarter: "spring-2023" },
            "DESN 263": { average: 18, peak: 25, trend: "stable", peakQuarter: "spring-2023" },
            "DESN 301": { average: 21, peak: 25, trend: "growing", peakQuarter: "fall-2024" },
            "DESN 305": { average: 22, peak: 23, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 326": { average: 25, peak: 25, trend: "stable", peakQuarter: "fall-2023" },
            "DESN 335": { average: 24, peak: 24, trend: "stable", peakQuarter: "winter-2025" },
            "DESN 336": { average: 18, peak: 21, trend: "growing", peakQuarter: "spring-2025" },
            "DESN 338": { average: 20, peak: 30, trend: "declining", peakQuarter: "fall-2022" },
            "DESN 345": { average: 0, peak: 0, trend: "new", peakQuarter: "never-offered", isNew: true },
            "DESN 348": { average: 16, peak: 20, trend: "stable", peakQuarter: "winter-2024" },
            "DESN 350": { average: 10, peak: 10, trend: "stable", peakQuarter: "spring" },
            "DESN 355": { average: 19, peak: 22, trend: "stable", peakQuarter: "winter-2024" },
            "DESN 359": { average: 19, peak: 24, trend: "growing", peakQuarter: "winter-2024" },
            "DESN 360": { average: 17, peak: 19, trend: "stable", peakQuarter: "winter-2025" },
            "DESN 365": { average: 15, peak: 16, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 366": { average: 12, peak: 18, trend: "declining", peakQuarter: "spring-2023" },
            "DESN 368": { average: 18, peak: 20, trend: "stable", peakQuarter: "fall" },
            "DESN 369": { average: 0, peak: 0, trend: "new", peakQuarter: "never-offered", isNew: true, note: "New course - Web Dev 1 (Winter 2026)" },
            "DESN 374": { average: 22, peak: 25, trend: "stable", peakQuarter: "fall" },
            "DESN 378": { average: 15, peak: 16, trend: "stable", peakQuarter: "winter" },
            "DESN 379": { average: 0, peak: 0, trend: "new", peakQuarter: "never-offered", isNew: true, note: "New course - Web Dev 2 (Spring 2026)" },
            "DESN 384": { average: 19, peak: 24, trend: "stable", peakQuarter: "winter-2023" },
            "DESN 401": { average: 16, peak: 21, trend: "growing", peakQuarter: "winter-2025" },
            "DESN 458": { average: 12, peak: 15, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 463": { average: 16, peak: 24, trend: "growing", peakQuarter: "spring-2025" },
            "DESN 468": { average: 12, peak: 13, trend: "stable", peakQuarter: "spring-2024" },
            "DESN 480": { average: 15, peak: 20, trend: "stable", peakQuarter: "winter-2023" },
            "DESN 490": { average: 15, peak: 25, trend: "growing", peakQuarter: "spring-2025" }
        };

        // Census enrollment data - Program headcount
        const censusData = {
            quarters: ['Fall 2022', 'Winter 2023', 'Spring 2023', 'Fall 2023', 'Winter 2024', 'Spring 2024', 'Fall 2024', 'Winter 2025', 'Spring 2025', 'Fall 2025'],
            headcount: [91, 102, 99, 90, 99, 100, 128, 119, 125, 124],
            totalEnrollments: []
        };

        // Load dynamic enrollment data if available
        async function loadDynamicData() {
            try {
                const response = await fetch('./enrollment-dashboard-data.json');
                if (response.ok) {
                    window.enrollmentDashboardData = await response.json();
                    console.log('‚úÖ Loaded dynamic enrollment data from enrollment-dashboard-data.json');
                    console.log(`   Generated: ${window.enrollmentDashboardData.generatedAt}`);
                    console.log(`   Total Records: ${window.enrollmentDashboardData.totalRecords}`);
                    return true;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load enrollment-dashboard-data.json');
                console.warn('   Run: node scripts/process-enrollment-data.js to generate dynamic data');
            }
            return false;
        }

        // Initialize dashboard
        async function initDashboard() {
            // Try to load dynamic data first
            const dynamicLoaded = await loadDynamicData();

            // Replace enrollmentData with dynamic data if available
            if (dynamicLoaded && window.enrollmentDashboardData && window.enrollmentDashboardData.courseStats) {
                // COMPLETELY REPLACE enrollment data (not merge)
                Object.keys(enrollmentData).forEach(key => delete enrollmentData[key]);
                Object.assign(enrollmentData, window.enrollmentDashboardData.courseStats);
                console.log('‚úÖ Using dynamic enrollment data from JSON file');
                console.log('   Courses loaded:', Object.keys(enrollmentData).length);
                console.log('   Sample:', Object.keys(enrollmentData).slice(0, 3));

                // Also update census data if available
                if (window.enrollmentDashboardData.censusData) {
                    censusData.quarters = window.enrollmentDashboardData.censusData.quarters;
                    censusData.headcount = window.enrollmentDashboardData.censusData.headcount;
                    censusData.totalEnrollments = window.enrollmentDashboardData.censusData.totalEnrollments || [];
                    console.log('‚úÖ Using dynamic census data from JSON file');
                    console.log('   Quarters:', censusData.quarters.length);
                    console.log('   Total Enrollments:', censusData.totalEnrollments.length);
                }
            } else {
                console.log('‚ö†Ô∏è Using hardcoded enrollment data (fallback)');
                console.log('   Courses in fallback:', Object.keys(enrollmentData).length);
            }

            // Render all visualizations
            renderForecast();
            updateStats();
            renderOverallTrendChart();
            renderCourseLevelChart();
            renderTrendPieChart();
            renderTopCoursesChart();
            renderWinterTrendChart();
            renderProgramHeadcountChart();
            renderCumulativeCreditsChart();
            renderFacultyWorkloadChart();
            renderCapacityUtilization();
            renderCourseTable();
            renderInsights();

            // Trigger year filter to default to 2024-25
            document.getElementById('academicYearFilter').dispatchEvent(new Event('change'));
        }

        function renderForecast() {
            // Check if dynamic data is loaded
            if (window.enrollmentDashboardData && window.enrollmentDashboardData.forecast) {
                const forecast = window.enrollmentDashboardData.forecast;

                document.getElementById('forecastPredicted').textContent = forecast.predicted || '--';
                document.getElementById('forecastLower').textContent = forecast.lower95 || '--';
                document.getElementById('forecastUpper').textContent = forecast.upper95 || '--';

                const trendIcon = forecast.trend === 'declining' ? 'üìâ Declining' :
                                  forecast.trend === 'growing' ? 'üìà Growing' :
                                  forecast.trend === 'stable' ? '‚û°Ô∏è Stable' : forecast.trend;
                document.getElementById('forecastTrend').textContent = trendIcon;

                document.getElementById('forecastGrowth').textContent = forecast.growthRate || '--';
            } else {
                // Hide forecast panel if no data available
                const panel = document.getElementById('forecastPanel');
                if (panel) {
                    panel.style.display = 'none';
                }
                console.warn('‚ö†Ô∏è Forecast data not available. Run: node scripts/process-enrollment-data.js');
            }
        }

        function updateStats() {
            let declining = 0, growing = 0, stable = 0;

            Object.values(enrollmentData).forEach(course => {
                if (course.trend === 'declining') declining++;
                else if (course.trend === 'growing') growing++;
                else if (course.trend === 'stable') stable++;
            });

            document.getElementById('totalCourses').textContent = Object.keys(enrollmentData).length;
            document.getElementById('decliningCount').textContent = declining;
            document.getElementById('growingCount').textContent = growing;
            document.getElementById('stableCount').textContent = stable;
        }

        function renderOverallTrendChart() {
            const ctx = document.getElementById('overallTrendChart').getContext('2d');

            // Use real quarterly trends data if available
            let labels = [];
            let uniqueStudents = [];
            let totalEnrollments = [];

            if (window.enrollmentDashboardData && window.enrollmentDashboardData.censusData) {
                labels = window.enrollmentDashboardData.censusData.quarters || [];
                uniqueStudents = window.enrollmentDashboardData.censusData.headcount || [];
                totalEnrollments = window.enrollmentDashboardData.censusData.totalEnrollments || [];
            } else if (window.enrollmentDashboardData && window.enrollmentDashboardData.quarterlyTrends) {
                // Fallback to quarterly trends
                const sortedTrends = window.enrollmentDashboardData.quarterlyTrends.sort((a, b) => {
                    const order = { 'Fall': 0, 'Winter': 1, 'Spring': 2 };
                    const [seasonA, yearA] = a.quarter.split(' ');
                    const [seasonB, yearB] = b.quarter.split(' ');
                    if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
                    return order[seasonA] - order[seasonB];
                });

                labels = sortedTrends.map(t => t.quarter);
                uniqueStudents = sortedTrends.map(t => t.headcount);
            } else {
                // Fallback to hardcoded data (should not happen if JSON loaded)
                console.warn('‚ö†Ô∏è Using fallback enrollment data');
                labels = ['Fall 2022', 'Winter 2023', 'Spring 2023', 'Fall 2023', 'Winter 2024', 'Spring 2024', 'Fall 2024', 'Winter 2025', 'Spring 2025'];
                uniqueStudents = [75, 77, 85, 97, 86, 77, 75, 77, 80];
            }

            const datasets = [
                {
                    label: 'Unique Students',
                    data: uniqueStudents,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 5,
                    yAxisID: 'y'
                }
            ];

            // Add total enrollments if available
            if (totalEnrollments.length > 0) {
                datasets.push({
                    label: 'Total Seat Enrollments',
                    data: totalEnrollments,
                    borderColor: '#51cf66',
                    backgroundColor: 'rgba(81, 207, 102, 0.1)',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 3,
                    pointRadius: 5,
                    yAxisID: 'y1'
                });
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Unique Students',
                                color: '#667eea'
                            },
                            ticks: {
                                color: '#667eea'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: totalEnrollments.length > 0,
                            position: 'right',
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Total Seat Enrollments',
                                color: '#51cf66'
                            },
                            ticks: {
                                color: '#51cf66'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        function renderCourseLevelChart() {
            const ctx = document.getElementById('courseLevelChart').getContext('2d');

            // Categorize courses by level
            let foundationTotal = 0, intermediateTotal = 0, advancedTotal = 0;

            Object.entries(enrollmentData).forEach(([code, data]) => {
                const level = parseInt(code.split(' ')[1]);
                if (level < 300) foundationTotal += data.average;
                else if (level < 400) intermediateTotal += data.average;
                else advancedTotal += data.average;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Foundation\n(100-200)', 'Intermediate\n(300-level)', 'Advanced\n(400-level)'],
                    datasets: [{
                        label: 'Total Students (avg)',
                        data: [foundationTotal, intermediateTotal, advancedTotal],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(81, 207, 102, 0.8)'
                        ],
                        borderColor: [
                            '#667eea',
                            '#764ba2',
                            '#51cf66'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTrendPieChart() {
            const ctx = document.getElementById('trendPieChart').getContext('2d');

            let declining = 0, growing = 0, stable = 0, newCourses = 0;

            Object.values(enrollmentData).forEach(course => {
                if (course.trend === 'declining') declining++;
                else if (course.trend === 'growing') growing++;
                else if (course.trend === 'stable') stable++;
                else if (course.trend === 'new') newCourses++;
            });

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Declining', 'Growing', 'Stable', 'New'],
                    datasets: [{
                        data: [declining, growing, stable, newCourses],
                        backgroundColor: [
                            'rgba(255, 107, 107, 0.8)',
                            'rgba(81, 207, 102, 0.8)',
                            'rgba(116, 192, 252, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ],
                        borderColor: [
                            '#ff6b6b',
                            '#51cf66',
                            '#74c0fc',
                            '#9b59b6'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function renderTopCoursesChart() {
            const ctx = document.getElementById('topCoursesChart').getContext('2d');

            // Get top 10 courses by average enrollment
            const sortedCourses = Object.entries(enrollmentData)
                .filter(([_, data]) => !data.isNew)
                .sort((a, b) => b[1].average - a[1].average)
                .slice(0, 10);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCourses.map(([code, _]) => code),
                    datasets: [{
                        label: 'Average Enrollment',
                        data: sortedCourses.map(([_, data]) => data.average),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderWinterTrendChart() {
            const ctx = document.getElementById('winterTrendChart').getContext('2d');

            // Get courses with winter quarterly data
            const winterCourses = Object.entries(enrollmentData)
                .filter(([_, data]) => data.quarterly)
                .map(([code, data]) => {
                    const w2023 = data.quarterly['winter-2023']?.total || data.quarterly['winter-2023'] || 0;
                    const w2024 = data.quarterly['winter-2024']?.total || data.quarterly['winter-2024'] || 0;
                    const w2025 = data.quarterly['winter-2025']?.total || data.quarterly['winter-2025'] || 0;

                    // Predict Winter 2026 based on average of last 3 years
                    const w2026 = Math.round((w2023 + w2024 + w2025) / 3);

                    return { code, w2023, w2024, w2025, w2026 };
                });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Winter 2023', 'Winter 2024', 'Winter 2025', 'Winter 2026 (Projected)'],
                    datasets: winterCourses.map((course, index) => ({
                        label: course.code,
                        data: [course.w2023, course.w2024, course.w2025, course.w2026],
                        borderColor: `hsl(${index * 120}, 70%, 50%)`,
                        backgroundColor: `hsla(${index * 120}, 70%, 50%, 0.1)`,
                        tension: 0.4,
                        borderDash: (context) => {
                            // Make Winter 2026 dashed (index 3)
                            return context.dataIndex === 3 ? [5, 5] : [];
                        },
                        segment: {
                            borderDash: (context) => {
                                // Dash the line between Winter 2025 and Winter 2026
                                return context.p1DataIndex === 3 ? [5, 5] : [];
                            }
                        }
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderCourseTable() {
            const tbody = document.getElementById('courseTableBody');

            console.log('renderCourseTable called, enrollmentData keys:', Object.keys(enrollmentData).length);

            const sortedCourses = Object.entries(enrollmentData)
                .sort((a, b) => b[1].average - a[1].average);

            console.log('Course rows to render:', sortedCourses.length);

            // Clear existing rows
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            // Build rows safely without innerHTML
            sortedCourses.forEach(([code, data]) => {
                const trendIcon = data.trend === 'declining' ? 'üìâ' :
                                  data.trend === 'growing' ? 'üìà' :
                                  data.trend === 'new' ? '‚ú®' : '‚û°Ô∏è';

                const row = document.createElement('tr');

                const codeCell = document.createElement('td');
                const codeStrong = document.createElement('strong');
                codeStrong.textContent = code;
                codeCell.appendChild(codeStrong);

                const avgCell = document.createElement('td');
                avgCell.textContent = data.average;

                const peakCell = document.createElement('td');
                peakCell.textContent = data.peak;

                const quarterCell = document.createElement('td');
                quarterCell.textContent = data.peakQuarter;

                const trendCell = document.createElement('td');
                const trendBadge = document.createElement('span');
                trendBadge.className = 'trend-badge ' + data.trend;
                trendBadge.textContent = trendIcon + ' ' + data.trend;
                trendCell.appendChild(trendBadge);

                row.appendChild(codeCell);
                row.appendChild(avgCell);
                row.appendChild(peakCell);
                row.appendChild(quarterCell);
                row.appendChild(trendCell);

                tbody.appendChild(row);
            });
        }

        // Store chart instance for destruction/recreation
        let programHeadcountChartInstance = null;

        function renderProgramHeadcountChart() {
            const ctx = document.getElementById('programHeadcountChart').getContext('2d');

            // Destroy existing chart if it exists
            if (programHeadcountChartInstance) {
                programHeadcountChartInstance.destroy();
            }

            programHeadcountChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: censusData.quarters,
                    datasets: [{
                        label: 'Unique Students per Quarter',
                        data: censusData.headcount,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} students`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    if (index === 0) return '';
                                    const prevValue = censusData.headcount[index - 1];
                                    const currValue = censusData.headcount[index];
                                    const change = currValue - prevValue;
                                    const pct = ((change / prevValue) * 100).toFixed(1);
                                    return `Change: ${change > 0 ? '+' : ''}${change} (${pct}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            suggestedMin: 60,
                            suggestedMax: 100,
                            title: {
                                display: true,
                                text: 'Unique Students'
                            }
                        }
                    }
                }
            });
        }

        function renderCumulativeCreditsChart() {
            const ctx = document.getElementById('cumulativeCreditsChart').getContext('2d');

            // Use actual total seat enrollments from census data
            const academicYears = {
                '2022-23': { fall: 0, winter: 0, spring: 0 },
                '2023-24': { fall: 0, winter: 0, spring: 0 },
                '2024-25': { fall: 0, winter: 0, spring: 0 },
                '2025-26': { fall: 0, winter: 0, spring: 0 }
            };

            // Map census data to academic years (Fall YYYY starts academic year YYYY-YY+1)
            censusData.quarters.forEach((quarter, index) => {
                const totalEnrollments = censusData.totalEnrollments[index];

                // Parse quarter name to determine academic year
                // Academic year runs Fall ‚Üí Winter ‚Üí Spring (e.g., Fall 2022 ‚Üí Winter 2023 ‚Üí Spring 2023)
                if (quarter.includes('Fall 2022')) academicYears['2022-23'].fall = totalEnrollments;
                else if (quarter.includes('Winter 2023')) academicYears['2022-23'].winter = totalEnrollments;
                else if (quarter.includes('Spring 2023')) academicYears['2022-23'].spring = totalEnrollments;
                else if (quarter.includes('Fall 2023')) academicYears['2023-24'].fall = totalEnrollments;
                else if (quarter.includes('Winter 2024')) academicYears['2023-24'].winter = totalEnrollments;
                else if (quarter.includes('Spring 2024')) academicYears['2023-24'].spring = totalEnrollments;
                else if (quarter.includes('Fall 2024')) academicYears['2024-25'].fall = totalEnrollments;
                else if (quarter.includes('Winter 2025')) academicYears['2024-25'].winter = totalEnrollments;
                else if (quarter.includes('Spring 2025')) academicYears['2024-25'].spring = totalEnrollments;
                else if (quarter.includes('Fall 2025')) academicYears['2025-26'].fall = totalEnrollments;
                else if (quarter.includes('Winter 2026')) academicYears['2025-26'].winter = totalEnrollments;
                else if (quarter.includes('Spring 2026')) academicYears['2025-26'].spring = totalEnrollments;
            });

            // Create cumulative progression for each year
            const createCumulativeData = (year) => {
                const data = academicYears[year];
                return [
                    data.fall,                              // After Fall
                    data.fall + data.winter,                // After Fall + Winter
                    data.fall + data.winter + data.spring   // After Fall + Winter + Spring (full year)
                ];
            };

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['After Fall', 'After Winter', 'After Spring'],
                    datasets: [
                        {
                            label: '2022-23',
                            data: createCumulativeData('2022-23'),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 3,
                            pointRadius: 6
                        },
                        {
                            label: '2023-24',
                            data: createCumulativeData('2023-24'),
                            borderColor: '#51cf66',
                            backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 3,
                            pointRadius: 6
                        },
                        {
                            label: '2024-25',
                            data: createCumulativeData('2024-25'),
                            borderColor: '#ffa726',
                            backgroundColor: 'rgba(255, 167, 38, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 3,
                            pointRadius: 6
                        },
                        {
                            label: '2025-26 (In Progress)',
                            data: createCumulativeData('2025-26'),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 3,
                            pointRadius: 6,
                            borderDash: [5, 5]  // Dashed line for current year
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${value ? value.toLocaleString() : '0'} seat enrollments`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cumulative Seat Enrollments'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Academic Year Progress'
                            }
                        }
                    }
                }
            });
        }

        function renderFacultyWorkloadChart() {
            const ctx = document.getElementById('facultyWorkloadChart').getContext('2d');

            // Use capacity planning data for faculty capacity visualization
            let facultyData = [];
            let academicYear = '2025-26'; // Default to current year

            // Check if capacity planning data is available
            if (window.enrollmentDashboardData && window.enrollmentDashboardData.capacityPlanning) {
                const capacityData = window.enrollmentDashboardData.capacityPlanning[academicYear];

                if (capacityData && capacityData.fullTimeFaculty) {
                    // Build faculty data from capacity planning
                    facultyData = capacityData.fullTimeFaculty.map(faculty => ({
                        name: faculty.name,
                        capacity: faculty.capacity,
                        isFullTime: true
                    }));

                    // Sort by capacity (descending)
                    facultyData.sort((a, b) => b.capacity - a.capacity);

                    // Add adjunct indicator if any adjuncts are being used
                    if (capacityData.adjunctCount > 0) {
                        facultyData.push({
                            name: `Adjunct Pool (${capacityData.adjunctCount})`,
                            capacity: 0,
                            isFullTime: false,
                            note: 'Over-capacity demand'
                        });
                    }

                    // Update capacity info box with dynamic data
                    const infoBox = document.getElementById('capacityPlanningInfo');
                    if (infoBox) {
                        const netAvailable = capacityData.netAvailable || 0;
                        const totalCapacity = capacityData.totalFullTimeCapacity || 0;
                        const totalDemand = capacityData.totalDemand || 0;

                        // Clear and rebuild info box safely
                        while (infoBox.firstChild) {
                            infoBox.removeChild(infoBox.firstChild);
                        }

                        const intro = document.createElement('strong');
                        intro.textContent = 'üìä Capacity Planning:';
                        infoBox.appendChild(intro);
                        infoBox.appendChild(document.createTextNode(' This chart shows baseline teaching capacity for full-time faculty only. '));

                        const adjunctNote = document.createElement('strong');
                        adjunctNote.textContent = 'Adjunct capacity = 0';
                        infoBox.appendChild(adjunctNote);
                        infoBox.appendChild(document.createTextNode(' for planning purposes - any adjunct teaching indicates over-capacity demand beyond full-time faculty baseline.'));

                        infoBox.appendChild(document.createElement('br'));
                        infoBox.appendChild(document.createElement('br'));

                        infoBox.appendChild(document.createTextNode('Total baseline capacity for ' + academicYear + ': '));
                        const capacityStrong = document.createElement('strong');
                        capacityStrong.textContent = totalCapacity + ' credits/quarter';
                        infoBox.appendChild(capacityStrong);
                        infoBox.appendChild(document.createTextNode('. '));

                        const statusSpan = document.createElement('span');
                        if (netAvailable < 0) {
                            statusSpan.style.color = '#ff6b6b';
                            statusSpan.appendChild(document.createTextNode('Program is '));
                            const overStrong = document.createElement('strong');
                            overStrong.textContent = Math.abs(netAvailable).toFixed(1) + ' credits OVER baseline capacity';
                            statusSpan.appendChild(overStrong);
                            statusSpan.appendChild(document.createTextNode('.'));
                        } else {
                            statusSpan.style.color = '#51cf66';
                            statusSpan.appendChild(document.createTextNode('Net available capacity: '));
                            const availStrong = document.createElement('strong');
                            availStrong.textContent = netAvailable.toFixed(1) + ' credits';
                            statusSpan.appendChild(availStrong);
                        }
                        infoBox.appendChild(statusSpan);
                    }
                }
            } else {
                // Fallback: Show full-time faculty list with standard capacities
                console.warn('‚ö†Ô∏è No capacity planning data available');
                facultyData = [
                    { name: 'Sonja Durr', capacity: 45, isFullTime: true },
                    { name: 'Simeon Mills', capacity: 45, isFullTime: true },
                    { name: 'Meg Lybbert', capacity: 45, isFullTime: true },
                    { name: 'Ariel Sopu', capacity: 45, isFullTime: true },
                    { name: 'Travis Masingale', capacity: 36, isFullTime: true },
                    { name: 'Colin Manikoth', capacity: 36, isFullTime: true },
                    { name: 'Ginelle Hustrulid', capacity: 36, isFullTime: true },
                    { name: 'Melinda Breen (Chair)', capacity: 5, isFullTime: true }
                ];
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: facultyData.map(f => f.name),
                    datasets: [{
                        label: 'Baseline Capacity (Credits/Quarter)',
                        data: facultyData.map(f => f.capacity),
                        backgroundColor: facultyData.map(f =>
                            !f.isFullTime ? 'rgba(255, 107, 107, 0.8)' :
                            f.capacity >= 45 ? 'rgba(81, 207, 102, 0.8)' :
                            f.capacity >= 36 ? 'rgba(100, 181, 246, 0.8)' :
                            'rgba(255, 215, 61, 0.8)'
                        ),
                        borderColor: facultyData.map(f =>
                            !f.isFullTime ? '#ff6b6b' :
                            f.capacity >= 45 ? '#51cf66' :
                            f.capacity >= 36 ? '#64b5f6' :
                            '#ffd93d'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const faculty = facultyData[index];
                                    if (!faculty.isFullTime) {
                                        return 'Adjunct capacity = 0 (over-capacity indicator)';
                                    }
                                    return `Baseline Capacity: ${faculty.capacity} credits/quarter`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const faculty = facultyData[index];
                                    if (faculty.note) {
                                        return faculty.note;
                                    }
                                    return null;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Full-Time Faculty Baseline Capacity (${academicYear})`,
                            font: { size: 14, weight: 'normal' },
                            padding: { bottom: 10 }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Credits per Quarter'
                            }
                        }
                    }
                }
            });
        }

        function renderCapacityUtilization() {
            const grid = document.getElementById('capacityGrid');
            const capacity = 24; // Standard room capacity

            console.log('renderCapacityUtilization called, enrollmentData keys:', Object.keys(enrollmentData).length);

            const courses = Object.entries(enrollmentData)
                .filter(([_, data]) => !data.isNew)
                .map(([code, data]) => {
                    const utilization = (data.average / capacity) * 100;
                    const status = utilization > 100 ? 'over' : utilization > 90 ? 'near' : 'under';
                    const courseNum = parseInt(code.split(' ')[1]); // Extract course number
                    return { code, courseNum, ...data, utilization, status };
                })
                .sort((a, b) => b.courseNum - a.courseNum); // Sort by course number descending (490 to 100)

            console.log('Capacity cards to render:', courses.length);

            // Clear and rebuild grid safely
            while (grid.firstChild) {
                grid.removeChild(grid.firstChild);
            }

            courses.forEach(course => {
                const icon = course.status === 'over' ? 'üî¥' : course.status === 'near' ? 'üü°' : 'üü¢';

                const card = document.createElement('div');
                card.className = 'capacity-card ' + course.status;

                const title = document.createElement('div');
                title.className = 'capacity-title';
                title.textContent = icon + ' ' + course.code;

                const details = document.createElement('div');
                details.className = 'capacity-details';
                details.textContent = course.average + ' students / ' + capacity + ' capacity';
                details.appendChild(document.createElement('br'));
                details.appendChild(document.createTextNode(Math.round(course.utilization) + '% utilized'));

                card.appendChild(title);
                card.appendChild(details);
                grid.appendChild(card);
            });
        }

        function renderInsights() {
            const insightsList = document.getElementById('insightsList');

            const insights = [
                {
                    title: 'Winter Enrollment Concerns',
                    description: 'DESN 100 and DESN 216 show consistent decline in winter quarters (38‚Üí24‚Üí22 and 38‚Üí25‚Üí22 respectively). Consider consolidating sections.'
                },
                {
                    title: 'High Demand Courses',
                    description: 'DESN 216 (Digital Foundations) averages 52 students with peak at 73. This course consistently requires multiple sections and is a bottleneck for the program.'
                },
                {
                    title: 'Growing Upper-Division Interest',
                    description: 'DESN 490 (Capstone), DESN 463 (Community Design), and DESN 401 (Imaginary Worlds) show growing trends, indicating strong senior cohort growth.'
                },
                {
                    title: 'Low Enrollment Electives',
                    description: 'DESN 350 (Digital Photo), DESN 366 (Production Design), and DESN 458 (UX 3) average <15 students. Review offering frequency and marketing.'
                },
                {
                    title: 'UX Track Strength',
                    description: 'UX courses (DESN 338, 348, 458) maintain stable enrollment despite general decline, showing sustained interest in UX/Interaction Design track.'
                }
            ];

            // Clear and rebuild insights list safely
            while (insightsList.firstChild) {
                insightsList.removeChild(insightsList.firstChild);
            }

            insights.forEach(insight => {
                const item = document.createElement('div');
                item.className = 'insight-item';

                const titleEl = document.createElement('h3');
                titleEl.textContent = insight.title;

                const descEl = document.createElement('p');
                descEl.textContent = insight.description;

                item.appendChild(titleEl);
                item.appendChild(descEl);
                insightsList.appendChild(item);
            });
        }

        function generateReport() {
            alert('PDF report generation would export all charts, tables, and insights to a downloadable PDF file.');
        }

        // Event listeners for filters
        document.getElementById('courseFilter').addEventListener('change', function() {
            // Filter logic would be implemented here
            console.log('Filter by:', this.value);
        });

        document.getElementById('trendFilter').addEventListener('change', function() {
            // Filter logic would be implemented here
            console.log('Filter by trend:', this.value);
        });

        document.getElementById('academicYearFilter').addEventListener('change', function() {
            const selectedYear = this.value;
            console.log('Filter by academic year:', selectedYear);

            if (selectedYear === 'all') {
                // Restore original data
                if (window.enrollmentDashboardData && window.enrollmentDashboardData.censusData) {
                    censusData.quarters = window.enrollmentDashboardData.censusData.quarters;
                    censusData.headcount = window.enrollmentDashboardData.censusData.headcount;
                    censusData.totalEnrollments = window.enrollmentDashboardData.censusData.totalEnrollments || [];
                }
            } else {
                // Filter census data by selected year
                if (window.enrollmentDashboardData && window.enrollmentDashboardData.censusData) {
                    const originalQuarters = window.enrollmentDashboardData.censusData.quarters;
                    const originalHeadcount = window.enrollmentDashboardData.censusData.headcount;
                    const originalTotalEnrollments = window.enrollmentDashboardData.censusData.totalEnrollments || [];

                    const filtered = originalQuarters.reduce((acc, quarter, index) => {
                        // Check if quarter belongs to selected academic year
                        // Academic year format: "2022-23" includes Fall 2022, Winter 2023, Spring 2023
                        const yearMatch = selectedYear.match(/(\d{4})-(\d{2})/);
                        if (yearMatch) {
                            const startYear = yearMatch[1];
                            const endYear = '20' + yearMatch[2];

                            if (quarter.includes(startYear) || quarter.includes(endYear)) {
                                acc.quarters.push(quarter);
                                acc.headcount.push(originalHeadcount[index]);
                                acc.totalEnrollments.push(originalTotalEnrollments[index]);
                            }
                        }
                        return acc;
                    }, { quarters: [], headcount: [], totalEnrollments: [] });

                    censusData.quarters = filtered.quarters;
                    censusData.headcount = filtered.headcount;
                    censusData.totalEnrollments = filtered.totalEnrollments;
                }
            }

            // Re-render program headcount chart with filtered data
            renderProgramHeadcountChart();
            renderCumulativeCreditsChart();

            // Show filtered status in subtitle
            const subtitle = document.querySelector('.subtitle');
            if (selectedYear === 'all') {
                subtitle.textContent = 'EWU Design Program Analytics 2022-2025';
            } else {
                subtitle.textContent = `EWU Design Program Analytics - Academic Year ${selectedYear}`;
            }
        });

        // Initialize dashboard on load
        window.addEventListener('load', initDashboard);
    </script>
</body>
</html>
